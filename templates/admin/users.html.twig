{% extends 'base.html.twig' %}

{% block title %}Админка — Пользователи{% endblock %}

{% block stylesheets %}
  <link rel="stylesheet" href="{{ asset('assets/admin.css') }}">
{% endblock %}

{% block body %}
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">Панель администратора</div>
      <nav class="nav">
        <a href="{{ path('admin_index') }}">Главная</a>
        <a href="{{ path('admin_users') }}">Пользователи</a>
      </nav>
    </aside>
    <main class="content">
      <div class="top">
        <div>
          <div class="title">Пользователи</div>
          <div class="badge">Вы вошли как {{ app.user.email }}</div>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          {% if is_granted('ROLE_ADMIN') %}
            <a class="btn" href="{{ path('admin_users_new') }}">Создать</a>
          {% endif %}
          <a class="btn" href="{{ path('logout') }}">Выйти</a>
        </div>
      </div>

      <div class="card">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Имя</th>
              <th>Фамилия</th>
              <th>Email</th>
              <th>Роли</th>
              <th style="width:1%; white-space:nowrap;">Действия</th>
            </tr>
          </thead>
          <tbody>
            {% for u in users %}
              <tr>
                <td>{{ u.id }}</td>
                <td>{{ u.name }}</td>
                <td>{{ u.lastName }}</td>
                <td>{{ u.email }}</td>
                <td class="roles">
                  {% set names = [] %}
                  {% for code in u.roles %}
                    {% set names = names | merge([roleNames[code] is defined ? roleNames[code] : code]) %}
                  {% endfor %}
                  {{ names|join(', ') }}
                </td>
                <td>
                  <div style="display:flex; gap:8px;">
                    {% if is_granted('ROLE_SUPER_ADMIN') or (is_granted('ROLE_ADMIN') and not u.hasRole('ROLE_SUPER_ADMIN')) %}
                      <a class="btn" href="{{ path('admin_users_edit', {id: u.id}) }}" style="padding:6px 10px; font-size:13px;">Редактировать</a>
                      {% if app.user and app.user.id != u.id %}
                        <form method="post" action="{{ path('admin_users_delete', {id: u.id}) }}" onsubmit="return confirm('Удалить пользователя {{ u.email }}?');">
                          <input type="hidden" name="_token" value="{{ csrf_token('delete_user_' ~ u.id) }}">
                          <button class="btn" type="submit" style="padding:6px 10px; font-size:13px; background:#ef4444;">Удалить</button>
                        </form>
                      {% endif %}
                    {% endif %}
                  </div>
                </td>
              </tr>
            {% else %}
              <tr>
                <td colspan="6" style="color:#94a3b8;">Пользователей нет.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </main>
  </div>
{% endblock %}
