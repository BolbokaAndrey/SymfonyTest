{% extends 'base.html.twig' %}

{% block title %}Админка — {{ mode == 'edit' ? 'Редактировать' : 'Создать' }} новость{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('assets/admin.css') }}">
{% endblock %}

{% block body %}
    <div class="layout">
        {% include 'admin/components/sidebar.html.twig' %}
        <main class="content">
            {% embed 'admin/components/header.html.twig' %}
                {% block header_actions %}
                    <a class="btn" href="{{ path('admin_content_news') }}">Назад</a>
                {% endblock %}
            {% endembed %}
            <div class="card">
                {% if error %}
                    <div class="danger">{{ error }}</div>
                {% endif %}

                <form method="post" enctype="multipart/form-data">
                    <div class="field">
                        <label class="label" for="inputTitle">Название *</label>
                        <div class="control">
                            <input id="inputTitle" type="text" name="title" value="{{ news.title|default('') }}" required>
                        </div>
                        <small style="color: var(--muted); font-size: 12px;">{{ news.title }}</small>
                    </div>

                    {% if news.text %}
                        <div class="field">
                            <label class="label" for="inputText">{{ news.text.name|capitalize }}{% if news.text.required %} *{% endif %}</label>
                            <div class="control">
                                <textarea id="inputText" name="text" rows="8" placeholder="{{ news.text.description ?? 'Введите ' ~ news.text.name ~ '...' }}"{% if news.text.required %} required{% endif %}>{{ news.text.description|default('') }}</textarea>
                            </div>
                            {% if news.text.description %}
                                <small style="color: var(--muted); font-size: 12px;">{{ news.text.description }}</small>
                            {% endif %}
                        </div>
                    {% endif %}

                    {% if news.image %}
                        <div class="field">
                            <label class="label" for="inputPicture">{{ news.image.name|capitalize }}{% if news.image.required %} *{% endif %}</label>
                            <div class="control">
                                <input id="inputPicture" type="file" name="picture" accept="image/*"{% if news.image.required %} required{% endif %}>
                            </div>
                            {% if news.image.description %}
                                <small style="color: var(--muted); font-size: 12px;">{{ news.image.description }}</small>
                            {% else %}
                                <small style="color: var(--muted); font-size: 12px;">Поддерживаются форматы: JPG, PNG, GIF</small>
                            {% endif %}
                        </div>
                    {% endif %}

                    <div class="field">
                        <label class="label" for="inputActive">Дата активации *</label>
                        <div class="control">
                            <input id="inputActive" type="datetime-local" name="active" value="{{ news.activeAt|default('') }}" required>
                        </div>
                        <small style="color: var(--muted); font-size: 12px;">Укажите дату и время, когда новость должна стать активной</small>
                    </div>

                    {% if news.tags %}
                        <div id="tags-container">
                            {% for i in 1..3 %}
                                <div class="field tag-field">
                                    <label class="label" for="inputTags{{ i }}">
                                        {{ news.tags.name|capitalize }} {{ i }}{% if news.tags.required and loop.first %} *{% endif %}
                                    </label>
                                    <div class="control has-addons">
                                        <input id="inputTags{{ i }}" type="text" name="tags[]" class="input" {% if news.tags.required and loop.first %} required{% endif %}>
                                        {% if loop.first %}
                                            <button type="button" class="button is-small" onclick="addTagField()">
                                                <span class="icon is-small">
                                                    <i>+</i>
                                                </span>
                                                <span>Добавить тег</span>
                                            </button>
                                        {% else %}
                                            <button type="button" class="button is-small is-danger" onclick="this.closest('.tag-field').remove()">
                                                <span class="icon is-small">
                                                    <i>×</i>
                                                </span>
                                                <span>Удалить</span>
                                            </button>
                                        {% endif %}
                                    </div>
                                    {% if news.tags.description and loop.first %}
                                        <small style="color: var(--muted); font-size: 12px;">{{ news.tags.description }}</small>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>

                        <script>
                            function addTagField() {
                                const container = document.getElementById('tags-container');
                                const tagFields = document.querySelectorAll('.tag-field');
                                const newIndex = tagFields.length + 1;

                                const newField = document.createElement('div');
                                newField.className = 'field tag-field';
                                newField.innerHTML = `
                                    <label class="label" for="inputTags${newIndex}">
                                        {{ news.tags.name|capitalize }} ${newIndex}
                                    </label>
                                    <div class="control has-addons">
                                        <input id="inputTags${newIndex}" type="text" name="tags[]" class="input">
                                        <button type="button" class="button is-small is-danger" onclick="this.closest('.tag-field').remove()">
                                            <span class="icon is-small">
                                                <i>×</i>
                                            </span>
                                            <span>Удалить</span>
                                        </button>
                                    </div>
                                `;

                                container.appendChild(newField);
                            }
                        </script>

                        <style>
                            .has-addons {
                                display: flex;
                                align-items: center;
                                gap: 0.5rem;
                            }
                            .has-addons .input {
                                flex: 1;
                                max-width: 300px;
                                height: 2.5em;
                                border: none;
                                border-radius: 0;
                                padding: 0.5em 0.25em;
                                box-shadow: none;
                                background: transparent;
                            }
                            .has-addons .input:focus {
                                outline: none;
                                box-shadow: none;
                            }
                            .has-addons .button {
                                padding: 0.5em 1em;
                                border: 1px solid transparent;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 0.875rem;
                                height: 2.5em;
                                display: inline-flex;
                                align-items: center;
                                justify-content: center;
                                transition: all 0.2s ease;
                            }
                            .has-addons .button:not(.is-danger) {
                                background-color: #4a6cf7;
                                color: white;
                                border-color: #4a6cf7;
                            }
                            .has-addons .button:not(.is-danger):hover {
                                background-color: #3a5ce4;
                                border-color: #3a5ce4;
                            }
                            .has-addons .button.is-danger {
                                background-color: #f14668;
                                color: white;
                                border-color: #f14668;
                            }
                            .has-addons .button.is-danger:hover {
                                background-color: #e03250;
                                border-color: #e03250;
                            }
                            .tag-field {
                                margin-bottom: 1.25rem;
                            }
                            .icon {
                                display: inline-flex;
                                align-items: center;
                                justify-content: center;
                                width: 1em;
                                height: 1em;
                                margin-right: 0.25em;
                            }
                        </style>
                    {% endif %}

                    <div class="actions">
                        <button class="btn" type="submit">Сохранить</button>
                    </div>
                </form>
            </div>
        </main>
    </div>
{% endblock %}
